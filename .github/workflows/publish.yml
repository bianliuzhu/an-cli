name: Publish to npm

on:
  release:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Generate version number
        id: version
        run: |
          # 获取当前日期 (YY.MM.DD)
          DATE_VERSION=$(date +"%y.%-m.%-d")

          # 获取包名
          PACKAGE_NAME=$(node -p "require('./package.json').name")

          # 检查该日期版本是否存在，并获取当天的所有版本
          EXISTING_VERSIONS=$(npm view $PACKAGE_NAME versions --json 2>/dev/null || echo "[]")

          # 查找当天已发布的版本，获取最大序号
          MAX_PATCH=$(echo "$EXISTING_VERSIONS" | jq -r ".[]" | grep "^${DATE_VERSION}" | sed "s/${DATE_VERSION}//g" | sed 's/^\.//g' | sort -n | tail -1)

          if [ -z "$MAX_PATCH" ]; then
            # 当天第一次发布
            NEW_VERSION="$DATE_VERSION"
          else
            # 当天已有发布，序号+1
            if [ "$MAX_PATCH" = "" ] || [ "$MAX_PATCH" = "$DATE_VERSION" ]; then
              NEW_VERSION="${DATE_VERSION}.1"
            else
              NEXT_PATCH=$((MAX_PATCH + 1))
              NEW_VERSION="${DATE_VERSION}.${NEXT_PATCH}"
            fi
          fi

          echo "Generated version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # 使用 node 直接更新 package.json 中的版本号
          node -e "const fs = require('fs'); const pkg = require('./package.json'); pkg.version = '$NEW_VERSION'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, '\t') + '\n');"

          echo "Updated package.json to version $NEW_VERSION"

      - name: Build
        run: npm run build

      - name: Publish to npm
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@bianliuzhu'

      - name: Update package name for GitHub Packages
        run: |
          # 备份原始 package.json
          cp package.json package.json.backup

          # 为 GitHub Packages 添加作用域到包名
          node -e "const fs = require('fs'); const pkg = require('./package.json'); pkg.name = '@bianliuzhu/anl'; pkg.publishConfig = { registry: 'https://npm.pkg.github.com' }; fs.writeFileSync('package.json', JSON.stringify(pkg, null, '\t') + '\n');"

      - name: Publish to GitHub Packages
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore original package.json
        run: |
          # 恢复原始 package.json
          mv package.json.backup package.json

      - name: Create Git Tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add package.json
          git commit -m "chore: release version ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git tag "${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}" || echo "Tag already exists"
